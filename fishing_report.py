import streamlit as st
import pandas as pd
import plotly.graph_objects as go

# ==========================================
# 0. é¡µé¢é…ç½®ä¸è‡ªå®šä¹‰ CSS (ç•Œé¢ç¾åŒ–)
# ==========================================
st.set_page_config(
    page_title="2025å…¨çƒæ¸”å…·æˆ˜ç•¥å¤§å±",
    page_icon="ğŸ£",
    layout="wide",
    initial_sidebar_state="expanded"
)

# è‡ªå®šä¹‰CSSæ³¨å…¥
st.markdown("""
<style>
    .main-title {
        font-size: 3rem !important;
        color: #1E3A8A;
        text-align: center;
        font-weight: 700 !important;
        margin-bottom: 2rem !important;
    }
    .sub-header {
        font-size: 1.8rem !important;
        color: #334155;
        border-bottom: 2px solid #E2E8F0;
        padding-bottom: 10px;
        margin-top: 30px;
        margin-bottom: 20px;
    }
    [data-testid="stMetricValue"] {
        font-size: 2rem !important;
        color: #0F172A;
    }
    [data-testid="stSidebar"] {
        background-color: #F8FAFC;
    }
</style>
""", unsafe_allow_html=True)

# ==========================================
# 1. æ•°æ®å‡†å¤‡
# ==========================================
data = [
    # ç¬¬ä¸€æˆ˜åŒºï¼šç¡¬é¥µ
    {"æˆ˜åŒº": "è·¯äºšç¡¬é¥µ", "ç»†åˆ†å“ç±»": "Swimbait (å¤šèŠ‚é±¼)", "ä¾›åº”é“¾": "å±±ä¸œå¨æµ·/å¹¿ä¸œ", "æœºä¼šæŒ‡æ•°": 4, "ASP($)": "15-25",
     "ç«äº‰": "Temu Top1", "æ ¸å¿ƒé€»è¾‘": "å®¢å•ä»·é«˜ï¼ŒPPCç›¸å¯¹ä½ï¼Œç¤¼ç›’è£…æº¢ä»·é«˜"},
    {"æˆ˜åŒº": "è·¯äºšç¡¬é¥µ", "ç»†åˆ†å“ç±»": "Crankbait (èƒ–å­)", "ä¾›åº”é“¾": "å±±ä¸œå¨æµ·", "æœºä¼šæŒ‡æ•°": 1, "ASP($)": "6-10",
     "ç«äº‰": "çº¢æµ·æ­»æµ·", "æ ¸å¿ƒé€»è¾‘": "Rapalaå£å’å¤ªåšï¼Œç™½ç‰Œæ— åˆ©æ¶¦"},
    {"æˆ˜åŒº": "è·¯äºšç¡¬é¥µ", "ç»†åˆ†å“ç±»": "Minnow (ç±³è¯º)", "ä¾›åº”é“¾": "å¹¿ä¸œä¸œè", "æœºä¼šæŒ‡æ•°": 2, "ASP($)": "6-15",
     "ç«äº‰": "é«˜", "æ ¸å¿ƒé€»è¾‘": "é™¤éæœ‰é‡å¿ƒè½¬ç§»ç³»ç»Ÿä¸”ä½ä»·ï¼Œå¦åˆ™éš¾çªå›´"},
    {"æˆ˜åŒº": "è·¯äºšç¡¬é¥µ", "ç»†åˆ†å“ç±»": "Spinnerbait (å¤åˆäº®ç‰‡)", "ä¾›åº”é“¾": "å±±ä¸œå¨æµ·", "æœºä¼šæŒ‡æ•°": 4, "ASP($)": "5-8",
     "ç«äº‰": "è“æµ·", "æ ¸å¿ƒé€»è¾‘": "ç»„è£…éº»çƒ¦å¤§å–çœ‹ä¸ä¸Šï¼Œé€‚åˆèµ°é‡"},
    {"æˆ˜åŒº": "è·¯äºšç¡¬é¥µ", "ç»†åˆ†å“ç±»": "Topwater (æ³¢æ‰’)", "ä¾›åº”é“¾": "å±±ä¸œå¨æµ·", "æœºä¼šæŒ‡æ•°": 3, "ASP($)": "10-18",
     "ç«äº‰": "å­£èŠ‚æ€§å¼º", "æ ¸å¿ƒé€»è¾‘": "èµ„é‡‘åˆ©ç”¨ç‡ä½ï¼Œéœ€é…åˆäº’è¡¥äº§å“"},

    # ç¬¬äºŒæˆ˜åŒºï¼šè½¯é¥µ
    {"æˆ˜åŒº": "è½¯é¥µ", "ç»†åˆ†å“ç±»": "Ned Rig (çŸ­å°¾TPE)", "ä¾›åº”é“¾": "æ±Ÿè‹è¿äº‘æ¸¯", "æœºä¼šæŒ‡æ•°": 5, "ASP($)": "6-10",
     "ç«äº‰": "è“æµ·è¶‹åŠ¿", "æ ¸å¿ƒé€»è¾‘": "TPEæè´¨å£å’ï¼Œæ–°é’“æ³•çº¢åˆ©ï¼Œä¾›åº”æœªé¥±å’Œ"},
    {"æˆ˜åŒº": "è½¯é¥µ", "ç»†åˆ†å“ç±»": "Stick Baits (é¢æ¡è™«)", "ä¾›åº”é“¾": "æ±Ÿè‹è¿äº‘æ¸¯", "æœºä¼šæŒ‡æ•°": 1, "ASP($)": "0.6/æ¡",
     "ç«äº‰": "å¿ è¯šåº¦æé«˜", "æ ¸å¿ƒé€»è¾‘": "ç”¨æˆ·åªè®¤Yamamotoï¼Œå¾ˆéš¾åˆ‡å…¥"},
    {"æˆ˜åŒº": "è½¯é¥µ", "ç»†åˆ†å“ç±»": "Frog Lures (é›·è›™)", "ä¾›åº”é“¾": "å¹¿ä¸œä¸œè", "æœºä¼šæŒ‡æ•°": 3, "ASP($)": "8-15",
     "ç«äº‰": "ä¸­", "æ ¸å¿ƒé€»è¾‘": "å…³é”®åœ¨é˜²æ¼æ°´ï¼Œåšç²¾å“æœ‰æœºä¼š"},

    # ç¬¬ä¸‰æˆ˜åŒºï¼šæ¸”è½®
    {"æˆ˜åŒº": "æ¸”è½®", "ç»†åˆ†å“ç±»": "BFS Reel (å¾®ç‰©æ°´æ»´)", "ä¾›åº”é“¾": "å±±ä¸œå¨æµ·", "æœºä¼šæŒ‡æ•°": 5, "ASP($)": "60-100",
     "ç«äº‰": "é«˜å¢é•¿", "æ ¸å¿ƒé€»è¾‘": "æ¬§ç¾å¤§ç‰Œè¿Ÿé’ï¼Œä¸­å›½æŠ€æœ¯æˆç†Ÿï¼Œåˆ©æ¶¦æåš"},
    {"æˆ˜åŒº": "æ¸”è½®", "ç»†åˆ†å“ç±»": "Spincast (å°é—­è½®)", "ä¾›åº”é“¾": "æµ™æ±Ÿæ…ˆæºª", "æœºä¼šæŒ‡æ•°": 4, "ASP($)": "18-25",
     "ç«äº‰": "ä½", "æ ¸å¿ƒé€»è¾‘": "ç»“æ„ç®€å•ä¸ç‚¸çº¿ï¼Œé€‚åˆåšå„¿ç«¥/å¥³æ€§ç¤¼å“å¥—è£…"},
    {"æˆ˜åŒº": "æ¸”è½®", "ç»†åˆ†å“ç±»": "Spinning (çººè½¦è½®)", "ä¾›åº”é“¾": "æµ™æ±Ÿæ…ˆæºª", "æœºä¼šæŒ‡æ•°": 1, "ASP($)": "25-40",
     "ç«äº‰": "å„æ–­", "æ ¸å¿ƒé€»è¾‘": "KastKing/Shimanoå µæ­»èµ›é“ï¼Œæ— é¢„ç®—å‹¿ç¢°"},

    # ç¬¬å››æˆ˜åŒºï¼šæ”¶çº³
    {"æˆ˜åŒº": "æ”¶çº³ç³»ç»Ÿ", "ç»†åˆ†å“ç±»": "Sling Bag (è·¯äºšèƒ¸åŒ…)", "ä¾›åº”é“¾": "ç¦å»ºæ³‰å·", "æœºä¼šæŒ‡æ•°": 4, "ASP($)": "25-40",
     "ç«äº‰": "é«˜", "æ ¸å¿ƒé€»è¾‘": "åˆ©æ¶¦å¥¶ç‰›ï¼Œæ¢èŠ±è‰²/æ”¹è®¾è®¡å°±èƒ½å–ï¼Œæ— å„æ–­"},
    {"æˆ˜åŒº": "æ”¶çº³ç³»ç»Ÿ", "ç»†åˆ†å“ç±»": "Chest Pack (é£é’“èƒ¸æŒ‚)", "ä¾›åº”é“¾": "ç¦å»ºæ³‰å·", "æœºä¼šæŒ‡æ•°": 4, "ASP($)": "30-60",
     "ç«äº‰": "æä½", "æ ¸å¿ƒé€»è¾‘": "éšå½¢è“æµ·ï¼Œé£é’“äººç¾¤ä¸“ç”¨ï¼Œç«äº‰å¯¹æ‰‹å°‘"},
    {"æˆ˜åŒº": "æ”¶çº³ç³»ç»Ÿ", "ç»†åˆ†å“ç±»": "Lure Binder (è½¯é¥µå†Œ)", "ä¾›åº”é“¾": "ç¦å»ºæ³‰å·", "æœºä¼šæŒ‡æ•°": 4, "ASP($)": "15-25",
     "ç«äº‰": "ä½", "æ ¸å¿ƒé€»è¾‘": "è¢«å¿½è§†çš„å°èµ›é“ï¼Œå¤è´­ç‡é«˜ï¼Œé€‚åˆç§æ¨¡"},
    {"æˆ˜åŒº": "æ”¶çº³ç³»ç»Ÿ", "ç»†åˆ†å“ç±»": "Backpack (åŒè‚©åŒ…)", "ä¾›åº”é“¾": "ç¦å»ºæ³‰å·", "æœºä¼šæŒ‡æ•°": 2, "ASP($)": "45-80",
     "ç«äº‰": "çº¢æµ·", "æ ¸å¿ƒé€»è¾‘": "Piscifunä¸»æˆ˜åœºï¼Œä½“ç§¯å¤§ç‰©æµè´¹é«˜"},
    {"æˆ˜åŒº": "æ”¶çº³ç³»ç»Ÿ", "ç»†åˆ†å“ç±»": "Rod Case (ç¡¬è´¨ç«¿ç­’)", "ä¾›åº”é“¾": "æµ™æ±Ÿå®æ³¢", "æœºä¼šæŒ‡æ•°": 1, "ASP($)": "30-60",
     "ç«äº‰": "ç‰©æµå™©æ¢¦", "æ ¸å¿ƒé€»è¾‘": "FBAè¿è´¹æè´µï¼Œå¿…äº"},

    # ç¬¬äº”æˆ˜åŒºï¼šæœé¥°
    {"æˆ˜åŒº": "æœé¥°ç©¿æˆ´", "ç»†åˆ†å“ç±»": "Sun Gloves (é˜²æ™’æ‰‹å¥—)", "ä¾›åº”é“¾": "æµ™æ±Ÿä¹‰ä¹Œ", "æœºä¼šæŒ‡æ•°": 4, "ASP($)": "12-20",
     "ç«äº‰": "é«˜", "æ ¸å¿ƒé€»è¾‘": "èµ°é‡ç¥å™¨ï¼Œä¹‰ä¹Œè´§æºæä¾¿å®œï¼Œåšå¤šåŒè£…"},
    {"æˆ˜åŒº": "æœé¥°ç©¿æˆ´", "ç»†åˆ†å“ç±»": "Waders (æ¶‰æ°´è£¤)", "ä¾›åº”é“¾": "ç¦å»ºç¦å·", "æœºä¼šæŒ‡æ•°": 3, "ASP($)": "60-150",
     "ç«äº‰": "å”®åéš¾", "æ ¸å¿ƒé€»è¾‘": "å¯Œè´µé™©ä¸­æ±‚ï¼Œå•åˆ©é«˜ä½†é€€è´§ç‡æå…¶æŠ˜ç£¨"},
    {"æˆ˜åŒº": "æœé¥°ç©¿æˆ´", "ç»†åˆ†å“ç±»": "Performance Shirt", "ä¾›åº”é“¾": "ç¦å»ºç¦å·", "æœºä¼šæŒ‡æ•°": 2, "ASP($)": "25-45",
     "ç«äº‰": "æé«˜", "æ ¸å¿ƒé€»è¾‘": "Huk/Columbiaå„æ–­ï¼Œæ˜“ç§¯å‹åº“å­˜"},

    # ç¬¬å…­æˆ˜åŒºï¼šå·¥å…·
    {"æˆ˜åŒº": "å·¥å…·äº”é‡‘", "ç»†åˆ†å“ç±»": "Line Spooler (ä¸Šçº¿å™¨)", "ä¾›åº”é“¾": "å¹¿ä¸œé˜³æ±Ÿ", "æœºä¼šæŒ‡æ•°": 4, "ASP($)": "20-30",
     "ç«äº‰": "ä¸­", "æ ¸å¿ƒé€»è¾‘": "åˆšéœ€ç—›ç‚¹å·¥å…·ï¼Œæ³¨æ„è§„é¿ä¸“åˆ©"},
    {"æˆ˜åŒº": "å·¥å…·äº”é‡‘", "ç»†åˆ†å“ç±»": "Magnetic Release (ç£åŠ›æ‰£)", "ä¾›åº”é“¾": "å¹¿ä¸œé˜³æ±Ÿ", "æœºä¼šæŒ‡æ•°": 4,
     "ASP($)": "10-15", "ç«äº‰": "ä¸­", "æ ¸å¿ƒé€»è¾‘": "ç»“æ„ç®€å•ï¼Œåˆ©æ¶¦ç‡æƒŠäººï¼Œé€‚åˆåšå¤šè‰²"},
    {"æˆ˜åŒº": "å·¥å…·äº”é‡‘", "ç»†åˆ†å“ç±»": "Lip Gripper (æ§é±¼å™¨)", "ä¾›åº”é“¾": "å¹¿ä¸œé˜³æ±Ÿ", "æœºä¼šæŒ‡æ•°": 3, "ASP($)": "20-30",
     "ç«äº‰": "é«˜", "æ ¸å¿ƒé€»è¾‘": "å¿…é¡»å¸¦ç”µå­ç§¤åŠŸèƒ½æ‰æœ‰æº¢ä»·"},
    {"æˆ˜åŒº": "å·¥å…·äº”é‡‘", "ç»†åˆ†å“ç±»": "Pliers (è·¯äºšé’³)", "ä¾›åº”é“¾": "å¹¿ä¸œé˜³æ±Ÿ", "æœºä¼šæŒ‡æ•°": 2, "ASP($)": "15-25",
     "ç«äº‰": "çº¢æµ·", "æ ¸å¿ƒé€»è¾‘": "PPCåƒå…‰åˆ©æ¶¦ï¼Œé™¤éæ‹¼é¢œå€¼æˆ–å¥—è£…"},

    # ç¬¬ä¸ƒæˆ˜åŒºï¼šç»ˆç«¯
    {"æˆ˜åŒº": "ç»ˆç«¯é…ä»¶", "ç»†åˆ†å“ç±»": "Tungsten Weights (é’¨å )", "ä¾›åº”é“¾": "æ¹–å—æ ªæ´²", "æœºä¼šæŒ‡æ•°": 4, "ASP($)": "18-25",
     "ç«äº‰": "è¶‹åŠ¿", "æ ¸å¿ƒé€»è¾‘": "ç¯ä¿æ”¿ç­–çº¢åˆ©ï¼Œé«˜å®¢å•ä»·ï¼Œåˆ©æ¶¦é¢é«˜"},
    {"æˆ˜åŒº": "ç»ˆç«¯é…ä»¶", "ç»†åˆ†å“ç±»": "Swivels (è½¬ç¯)", "ä¾›åº”é“¾": "å¹¿ä¸œä¸œè", "æœºä¼šæŒ‡æ•°": 2, "ASP($)": "7-10",
     "ç«äº‰": "å‡‘å•", "æ ¸å¿ƒé€»è¾‘": "å•å–å¿…äºï¼Œå¿…é¡»åšå¤§åŒ…è£…"},

    # ç¬¬å…«æˆ˜åŒºï¼šç”µå­
    {"æˆ˜åŒº": "ç”µå­è£…å¤‡", "ç»†åˆ†å“ç±»": "Bite Alarms (æŠ¥è­¦å™¨)", "ä¾›åº”é“¾": "å¹¿ä¸œæ·±åœ³", "æœºä¼šæŒ‡æ•°": 4, "ASP($)": "35-50",
     "ç«äº‰": "è“æµ·", "æ ¸å¿ƒé€»è¾‘": "æ¬§æ´²æ ‡é…ï¼Œç¾å›½èµ·æ­¥ï¼Œé«˜ç§‘æŠ€å±æ€§æº¢ä»·"},
    {"æˆ˜åŒº": "ç”µå­è£…å¤‡", "ç»†åˆ†å“ç±»": "Bait Boat (æ‰“çªèˆ¹)", "ä¾›åº”é“¾": "å¹¿ä¸œæ·±åœ³", "æœºä¼šæŒ‡æ•°": 3, "ASP($)": "250+",
     "ç«äº‰": "é«˜é—¨æ§›", "æ ¸å¿ƒé€»è¾‘": "åˆ©æ¶¦æé«˜ï¼Œä½†å”®åé£é™©æ¯ç­æ€§"}
]
df = pd.DataFrame(data)

# ==========================================
# 2. æ ‡é¢˜ä¸æŒ‡æ ‡
# ==========================================
st.markdown('<h1 class="main-title">ğŸ£ 2025 å…¨çƒæ¸”å…·å¸‚åœºç»“æ„ä¸ä¾›åº”é“¾æˆ˜ç•¥å¤§å±</h1>', unsafe_allow_html=True)

col1, col2, col3, col4 = st.columns(4)
col1.metric("è¦†ç›–ç»†åˆ†å“ç±»", f"{len(df)} ä¸ª", delta="å…¨äº§ä¸šé“¾")
col2.metric("é«˜æœºä¼šå“ç±» (4æ˜Ÿ+)", f"{len(df[df['æœºä¼šæŒ‡æ•°'] >= 4])} ä¸ª", delta="æ¨èé‡ç‚¹å…³æ³¨", delta_color="inverse")
col3.metric("æ ¸å¿ƒä¾›åº”é“¾åŸå¸‚", f"{len(df['ä¾›åº”é“¾'].unique())} ä¸ª", help="å¨æµ·ã€å®æ³¢ã€æ³‰å·ã€é˜³æ±Ÿç­‰")
col4.metric("å¹³å‡ASPåŒºé—´", "$5 - $250+", help="è¦†ç›–å…¥é—¨åˆ°é«˜ç«¯")

# ==========================================
# 3. æ¡‘åŸºå›¾ (å·²ä¿®å¤ textfont é”™è¯¯)
# ==========================================
st.markdown('<h2 class="sub-header">ğŸŒ äº§ä¸šé“¾æµå‘å…¨æ™¯å›¾</h2>', unsafe_allow_html=True)

# å‡†å¤‡èŠ‚ç‚¹
supply_nodes = list(df['ä¾›åº”é“¾'].unique())
zone_nodes = list(df['æˆ˜åŒº'].unique())
category_nodes = list(df['ç»†åˆ†å“ç±»'].unique())
all_nodes = supply_nodes + zone_nodes + category_nodes
node_map = {name: i for i, name in enumerate(all_nodes)}

# èŠ‚ç‚¹é¢œè‰²
node_colors = []
for node in all_nodes:
    if node in supply_nodes:
        node_colors.append("#2563EB")
    elif node in zone_nodes:
        node_colors.append("#D97706")
    else:
        node_colors.append("#059669")

# é“¾è·¯æ•°æ®
sources = []
targets = []
values = []
link_colors = []
link_hover_labels = []

opportunity_color_map = {
    5: "rgba(16, 185, 129, 0.85)",
    4: "rgba(52, 211, 153, 0.8)",
    3: "rgba(251, 191, 36, 0.7)",
    2: "rgba(251, 146, 60, 0.6)",
    1: "rgba(239, 68, 68, 0.5)"
}

for _, row in df.iterrows():
    sources.append(node_map[row['ä¾›åº”é“¾']])
    targets.append(node_map[row['æˆ˜åŒº']])
    values.append(1)
    link_colors.append("rgba(200, 200, 200, 0.3)")
    link_hover_labels.append(f"è·¯å¾„: {row['ä¾›åº”é“¾']} â†’ {row['æˆ˜åŒº']}")

    sources.append(node_map[row['æˆ˜åŒº']])
    targets.append(node_map[row['ç»†åˆ†å“ç±»']])
    values.append(1)
    link_colors.append(opportunity_color_map[row['æœºä¼šæŒ‡æ•°']])
    link_hover_labels.append(f"å“ç±»: {row['ç»†åˆ†å“ç±»']}<br>æœºä¼š: {row['æœºä¼šæŒ‡æ•°']}æ˜Ÿ<br>é€»è¾‘: {row['æ ¸å¿ƒé€»è¾‘']}")

# æ„å»ºå›¾è¡¨ (ä¿®æ­£ç‚¹ï¼štextfont ç§»å‡º node)
fig = go.Figure(data=[go.Sankey(
    valueformat=".0f",
    valuesuffix="é¡¹",
    # ä¿®æ­£ï¼štextfont æ˜¯ Sankey çš„ç›´æ¥å±æ€§ï¼Œä¸æ˜¯ node çš„å±æ€§
    textfont=dict(size=14, color="black", family="Arial Black"),
    node=dict(
        pad=25,
        thickness=25,
        line=dict(color="white", width=1),
        label=all_nodes,
        color=node_colors,
        hovertemplate='èŠ‚ç‚¹: %{label}<extra></extra>'
    ),
    link=dict(
        source=sources,
        target=targets,
        value=values,
        color=link_colors,
        hovertemplate='%{customdata}<extra></extra>',
        customdata=link_hover_labels
    ))])

fig.update_layout(
    font_size=14,
    height=900,
    margin=dict(t=20, l=20, r=20, b=20),
    paper_bgcolor='rgba(0,0,0,0)',
    plot_bgcolor='rgba(0,0,0,0)'
)

st.plotly_chart(fig, use_container_width=True)

# ==========================================
# 4. æ•°æ®è¡¨
# ==========================================
st.markdown('<h2 class="sub-header">ğŸ“Š ç»†åˆ†å“ç±»å†³ç­–çŸ©é˜µ</h2>', unsafe_allow_html=True)

st.sidebar.title("ğŸ” ç­›é€‰æ§åˆ¶å™¨")
selected_zone = st.sidebar.multiselect("æ‰€å±æˆ˜åŒº", df['æˆ˜åŒº'].unique())
selected_supply = st.sidebar.multiselect("ä¾›åº”é“¾äº§åœ°", df['ä¾›åº”é“¾'].unique())
min_star = st.sidebar.slider("æœ€ä½æœºä¼šæŒ‡æ•°", 1, 5, 1)

filtered_df = df.copy()
if selected_zone:
    filtered_df = filtered_df[filtered_df['æˆ˜åŒº'].isin(selected_zone)]
if selected_supply:
    filtered_df = filtered_df[filtered_df['ä¾›åº”é“¾'].isin(selected_supply)]
filtered_df = filtered_df[filtered_df['æœºä¼šæŒ‡æ•°'] >= min_star]

st.dataframe(
    filtered_df,
    column_order=("ç»†åˆ†å“ç±»", "æœºä¼šæŒ‡æ•°", "æˆ˜åŒº", "ä¾›åº”é“¾", "ASP($)", "ç«äº‰", "æ ¸å¿ƒé€»è¾‘"),
    column_config={
        "ç»†åˆ†å“ç±»": st.column_config.TextColumn("ç»†åˆ†å“ç±»", width="medium"),
        "æœºä¼šæŒ‡æ•°": st.column_config.ProgressColumn(
            "æœºä¼šæŒ‡æ•°", format="%d æ˜Ÿ", min_value=1, max_value=5
        ),
        "æˆ˜åŒº": st.column_config.TextColumn("æ‰€å±æˆ˜åŒº", width="small"),
        "æ ¸å¿ƒé€»è¾‘": st.column_config.TextColumn("æ ¸å¿ƒé€»è¾‘", width="large"),
    },
    hide_index=True,
    use_container_width=True,
    height=600
)